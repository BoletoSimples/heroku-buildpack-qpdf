#!/bin/sh

indent() {
  sed -u 's/^/       /'
}

echo "--------> Installing qpdf"
BUILD_DIR=$1
VENDOR_DIR="vendor/qpdf"
DOWNLOAD_BASE_PATH="http://us-west-2.clouds.archive.ubuntu.com/ubuntu/pool/main/q/qpdf"
LIB_DPKG=libqpdf13_5.1.1-1_amd64.deb
BIN_DPKG=qpdf_5.1.1-1_amd64.deb

echo "Creating directories" | indent
cd $BUILD_DIR
mkdir -p $VENDOR_DIR
cd $VENDOR_DIR

echo "Downloading binaries" | indent
wget --quiet $DOWNLOAD_BASE_PATH/$LIB_DPKG
wget --quiet $DOWNLOAD_BASE_PATH/$BIN_DPKG

echo "Installing binaries" | indent
dpkg -x ./$LIB_DPKG .
dpkg -x ./$BIN_DPKG .

echo "Moving binaries" | indent
mv ./usr/* .

echo "Removing packages" | indent
rm -r usr *.deb

echo "exporting PATH and LD_LIBRARY_PATH" | indent
PROFILE_PATH="$BUILD_DIR/.profile.d/qpdf.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="/app/vendor/qpdf/bin:$PATH"' >> $PROFILE_PATH
echo 'export LD_LIBRARY_PATH="/app/vendor/qpdf/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"' >> $PROFILE_PATH

echo "-------> Install qpdf complete"